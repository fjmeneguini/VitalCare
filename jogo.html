<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VitalCare - A Triagem Ca√≥tica</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">


    <link rel="stylesheet" href="styles.css">
</head>
<body>
    
    <div id="background-symbols"></div>

    <div id="ranking-overlay" class="overlay-screen">
        <div id="ranking-panel">
            <div class="main-title" style="margin-bottom: 20px;">VITAL CARE</div>
            <h2 style="color: #7FFFD4;">Seja o Triagista Mais R√°pido!</h2>
            <div id="ranking-list">
                <ul id="ranking"></ul>
            </div>
            <form id="name-form">
                <input type="text" id="player-name-input" placeholder="Seu Nome/Apelido" required>
                <button type="submit" class="start-button-style" id="start-button-overlay" style="margin-top: 15px;">COME√áAR PLANT√ÉO</button>
            </form>
            
            <button id="export-ranking-button" class="start-button-style" 
                    style="margin-top: 30px; background-color: #993BC7; color: white; display: none;">
                EXPORTAR RANKING COMPLETO (CSV)
            </button>
        </div>
    </div>

    <div class="game-container">
        
        <div class="logo-header">
             <img src="logo_vitalcare.png" alt="Logo VitalCare"> 
        </div>
        
        <div class="main-title" style="margin-bottom: 10px;">VITAL CARE</div>
        
        <h1>A Triagem Ca√≥tica: N√≠vel TCC</h1>
        <p>20s de Plant√£o. CLIQUE nos Alvos de Ponto (+). Clicar no Vermelho (üõë) √© PUNI√á√ÉO (-8 pontos).</p>

        <div id="score-display">Pontos: <span id="score">0</span></div>
        <div id="timer-display">20s</div>

        <div id="game-area">
            <button id="start-button">INICIAR PLANT√ÉO DE 20 SEGUNDOS</button>
        </div>

        <div id="score-feedback" aria-live="polite">
            <div id="last-hit" aria-hidden="true"></div>
            <div id="running-total">0 pts</div>
        </div>

        <p id="result-message">Seu foco e velocidade definem o pr√™mio.</p>
        
        <div id="final-results" style="display: none;"></div>

    </div>

    <script>
        /*
          Script principal do jogo - controles, persist√™ncia local e integra√ß√£o com ranking remoto.
          Descri√ß√µes em portugu√™s foram adicionadas para facilitar manuten√ß√£o.

          Responsabilidades principais:
          - Gerenciar fluxo do jogo (iniciar, temporizador, gerar alvos, finalizar)
          - Controlar pontua√ß√£o, feedback visual e sonoro (Web Audio sintetizado)
          - Persistir scores localmente e enviar para ranking remoto via `ranking.js` (quando dispon√≠vel)
          - Aplicar limite de jogadas por nome (kiosk mode) e exce√ß√µes VIP
        */

        // --- CHAVES DO LOCALSTORAGE --- (armazenamento local para fallback)
        const RANKING_KEY = 'vitalcareRanking';
        const PLAY_COUNTS_KEY = 'vitalcarePlayCounts';
        const LAST_USED_NAME_KEY = 'vitalcareLastUsedName'; 
        
        // --- Lista de Exce√ß√£o VIP (Jogadas Ilimitadas) ---
        // Nomes aqui s√£o tratados como exce√ß√µes: os usu√°rios listados n√£o t√™m limite de jogadas locais
        const VIP_USERS = ['Wydgui', 'Fefe01', 'Laurao'];

        // --- VARI√ÅVEIS DE CONTROLE DO DOM E DO JOGO ---
        const gameArea = document.getElementById('game-area');
        const scoreDisplay = document.getElementById('score');
        const timerDisplay = document.getElementById('timer-display');
        const startButton = document.getElementById('start-button');
        const resultMessage = document.getElementById('result-message');
        const finalResultsContainer = document.getElementById('final-results');
        const backgroundSymbols = document.getElementById('background-symbols');
        const rankingOverlay = document.getElementById('ranking-overlay');
        const rankingListDiv = document.getElementById('ranking-list');
        const nameForm = document.getElementById('name-form');
        const playerNameInput = document.getElementById('player-name-input');
        const exportButton = document.getElementById('export-ranking-button');
        const overlayStartButton = document.getElementById('start-button-overlay');
        
        // Estado do jogo
        let score = 0;
        let timeLeft = 0;
        let isRunning = false;
        let generatorInterval;
        let timerInterval;

        let criticalHits = 0;
        let coffeeHits = 0;
        let distractionFails = 0;
        let currentPlayerName = 'An√¥nimo'; 
        let gameID = 0;
        
        // Limite local de jogadas por nome (kiosk mode)
        const MAX_PLAYS = 3; 
        
        // Configura√ß√µes de jogo: dura√ß√£o, taxa de gera√ß√£o e tempo de vida dos alvos
        const GAME_DURATION = 20; 
        const BASE_GEN_RATE = 300; 
        const BASE_LIFESPAN = 1200; 
        
        // CONFIGURA√á√ÉO DE PONTUA√á√ÉO (PUNITIVA)
        // Distra√ß√£o (üõë) d√° -8 pontos, mas n√£o encerra mais o jogo.
        const ITEM_CONFIG = [
            { type: 'critical', icon: 'üö®', points: 10, weight: 2 }, 
            { type: 'coffee', icon: '‚òï', points: 3, weight: 3 },    
            { type: 'distraction', icon: 'üõë', points: -8, weight: 9 } // -8 pontos
        ];

        // -------------------------
        // SONS (Web Audio API - sintetizados)
        // Descri√ß√µes: fun√ß√µes abaixo criam um AudioContext, tentam retomar quando necess√°rio
        // e implementam um pequeno debounce para evitar sobrecarga quando muitos eventos disparam.
        // -------------------------
        let audioCtx = null;
        let audioResumeRetryTimer = null;
        const SOUND_MIN_INTERVAL = 80; // ms entre execu√ß√µes do mesmo som para evitar sobrecarga
        let lastPositivePlay = 0;
        let lastNegativePlay = 0;

        // Garante que haja um AudioContext v√°lido e tenta 'resume' se estiver suspenso.
        function ensureAudioCtx() {
            if (!audioCtx) {
                const AC = window.AudioContext || window.webkitAudioContext;
                if (!AC) return null;
                audioCtx = new AC();
            }
            // Tenta retomar se estiver suspenso; faz algumas tentativas espa√ßadas.
            if (audioCtx.state === 'suspended') {
                audioCtx.resume().catch(()=>{});
                if (!audioResumeRetryTimer) {
                    let attempts = 0;
                    audioResumeRetryTimer = setInterval(() => {
                        attempts++;
                        if (!audioCtx) return;
                        if (audioCtx.state === 'running' || attempts > 6) {
                            clearInterval(audioResumeRetryTimer);
                            audioResumeRetryTimer = null;
                            return;
                        }
                        audioCtx.resume().catch(()=>{});
                    }, 80);
                }
            }
            return audioCtx;
        }

        // Som positivo sintetizado (dois osciladores em Sine)
        function playPositiveSound() {
            const ctx = ensureAudioCtx();
            if (!ctx) return;
            const nowMs = Date.now();
            if (nowMs - lastPositivePlay < SOUND_MIN_INTERVAL) return; // debounce
            lastPositivePlay = nowMs;
            console.log('[sound] playPositiveSound');
            const now = ctx.currentTime;
            const g = ctx.createGain();
            g.gain.setValueAtTime(0, now);
            g.gain.linearRampToValueAtTime(0.12, now + 0.005);
            g.gain.exponentialRampToValueAtTime(0.001, now + 0.18);
            g.connect(ctx.destination);

            const o1 = ctx.createOscillator();
            o1.type = 'sine';
            o1.frequency.setValueAtTime(880, now);
            o1.connect(g);

            const o2 = ctx.createOscillator();
            o2.type = 'sine';
            o2.frequency.setValueAtTime(660, now);
            const g2 = ctx.createGain();
            g2.gain.setValueAtTime(0.06, now);
            g2.connect(ctx.destination);
            o2.connect(g2);

            o1.start(now); o2.start(now);
            o1.stop(now + 0.18); o2.stop(now + 0.18);
        }

        // Som negativo sintetizado (sawtooth decrescente)
        function playNegativeSound() {
            const ctx = ensureAudioCtx();
            if (!ctx) return;
            const nowMs = Date.now();
            if (nowMs - lastNegativePlay < SOUND_MIN_INTERVAL) return; // debounce
            lastNegativePlay = nowMs;
            console.log('[sound] playNegativeSound');
            const now = ctx.currentTime;
            const g = ctx.createGain();
            g.gain.setValueAtTime(0.12, now);
            g.gain.exponentialRampToValueAtTime(0.001, now + 0.28);
            g.connect(ctx.destination);

            const o = ctx.createOscillator();
            o.type = 'sawtooth';
            o.frequency.setValueAtTime(320, now);
            o.frequency.exponentialRampToValueAtTime(130, now + 0.28);
            o.connect(g);
            o.start(now);
            o.stop(now + 0.28);
        }

        // Feedback visual de acertos/erros mostrado abaixo da √°rea do jogo
        let runningTotal = 0;
        const lastHitEl = document.getElementById('last-hit');
        const runningTotalEl = document.getElementById('running-total');

        // Mostra o √∫ltimo delta de pontos (+10, -8) e atualiza o total em execu√ß√£o
        function showHitFeedback(delta, icon) {
            const prefix = delta > 0 ? `+${delta}` : `${delta}`;
            lastHitEl.textContent = `${icon || ''} ${prefix} PONTOS`;
            lastHitEl.classList.remove('hit-pop');
            void lastHitEl.offsetWidth; // for√ßa reflow para reiniciar anima√ß√£o
            lastHitEl.classList.add('hit-pop');

            runningTotal += delta;
            runningTotalEl.textContent = `${runningTotal} pts`;
        }

        // Tenta desbloquear o AudioContext no primeiro gesto do usu√°rio (pointerdown ou keydown)
        function unlockAudioOnFirstGesture() {
            function _unlock() {
                ensureAudioCtx();
                window.removeEventListener('pointerdown', _unlock);
                window.removeEventListener('keydown', _unlock);
                console.log('[sound] audio unlocked by user gesture');
            }
            window.addEventListener('pointerdown', _unlock, { once: true });
            window.addEventListener('keydown', _unlock, { once: true });
        }

        // Inicializa listener para desbloquear √°udio quando usu√°rio interagir
        unlockAudioOnFirstGesture();

        // --- IN-GAME CTA ELEMENT (bot√£o centralizado para voltar ao ranking durante/apos jogo) ---
        const inGameCta = document.createElement('div');
        inGameCta.className = 'in-game-cta';
        inGameCta.innerHTML = `<button id="in-game-return-ranking" class="start-button-style" style="background:#993BC7; color:white">VOLTAR AO RANKING</button>`;
        gameArea.appendChild(inGameCta);
        const inGameReturnButton = inGameCta.querySelector('#in-game-return-ranking');
        inGameReturnButton.addEventListener('click', () => {
            displayRanking();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // --- FUN√á√ïES DE RANKING E CONTADORES (local + integra√ß√£o remota) ---
        // Notas: nomes s√£o normalizados para chave (lowercase+trim) para agrupar jogadas por pessoa.
        function loadPlayCounts() {
            return JSON.parse(localStorage.getItem(PLAY_COUNTS_KEY)) || {};
        }

        // Gera chave normalizada a partir do nome para contagem case-insensitive
        function normalizeNameKey(name) {
            return (name || '').trim().toLowerCase();
        }

        // Retorna quantas jogadas esse nome j√° consumiu localmente (VIP tem 0)
        function loadPlayCount(name) {
            const counts = loadPlayCounts();
            const key = normalizeNameKey(name);
            if (VIP_USERS.includes(name)) {
                return 0;
            }
            return counts[key] || 0;
        }

        // Incrementa e persiste contador de jogadas para o nome normalizado
        function incrementPlayCount(name) {
            let counts = loadPlayCounts();
            const key = normalizeNameKey(name);

            if (!VIP_USERS.includes(name)) {
                 counts[key] = (counts[key] || 0) + 1;
            }

            localStorage.setItem(PLAY_COUNTS_KEY, JSON.stringify(counts));
            return counts[key];
        }

        // Carrega ranking local e reduz para apenas o melhor score por jogador
        function loadRanking() {
            const rawRanking = JSON.parse(localStorage.getItem(RANKING_KEY)) || [];
            const bestScoresMap = new Map();

            rawRanking.forEach(entry => {
                const name = entry.name;
                if (!bestScoresMap.has(name) || entry.score > bestScoresMap.get(name).score) {
                    bestScoresMap.set(name, entry);
                }
            });

            const uniqueRanking = Array.from(bestScoresMap.values());
            uniqueRanking.sort((a, b) => b.score - a.score);

            return uniqueRanking;
        }

        // Prepara objeto de entrada e tenta enviar ao m√≥dulo de ranking remoto; se indispon√≠vel, grava localmente
        function saveScore(name, score, prize, hits, misses) {
                gameID = Date.now();

                const newEntry = {
                    id: gameID,
                    timestamp: new Date().toLocaleString('pt-BR'),
                    name: name,
                    score: score,
                    prize: prize,
                    criticalHits: hits,
                    distractionFails: misses,
                    redeemed: false
                };

                // Usa API compartilhada (ranking.js) quando dispon√≠vel
                if (typeof window.addPlayer === 'function') {
                    window.addPlayer(newEntry);
                } else {
                    // Fallback para localStorage
                    let rawRanking = JSON.parse(localStorage.getItem(RANKING_KEY)) || [];
                    rawRanking.push(newEntry);
                    localStorage.setItem(RANKING_KEY, JSON.stringify(rawRanking));
                }
        }

    // Exibe overlay de ranking. Preenche Top 5 local e √°rea "Ranking Global" com dados remotos quando dispon√≠veis.
    // Nota: Limite ajustado para Top 5 mediante solicita√ß√£o do mantenedor.
        function displayRanking() {
            const localRanking = loadRanking();
            const remoteCached = (window.getCachedRanking && typeof window.getCachedRanking === 'function') ? window.getCachedRanking() : null;

                        let html = '<ol>';
                        // Guia de pr√™mios vis√≠vel no overlay inicial
                        html += `<div id="prizes-guide" style="margin-top:10px; padding:12px; background:rgba(0,0,0,0.18); border-radius:8px; border:1px solid rgba(255,255,255,0.04);">` +
                                        `<strong>Pr√™mios e Pontua√ß√£o</strong>` +
                                        `<ul style="margin:8px 0 0 16px; padding:0; list-style:disc; color:#dfe7f2">` +
                                                            `<li><strong>Exclusivo (Cord√£o)</strong>: 120 pontos ou mais</li>` +
                                                            `<li><strong>M√©dio (Chaveiro Acr√≠lico Azul)</strong>: 100 - 119 pontos</li>` +
                                                            `<li><strong>Simples (Chaveiro MDF)</strong>: 60 - 99 pontos</li>` +
                                                            `<li><strong>Super Simples (Adesivo e Bala)</strong>: 0 - 59 pontos</li>` +
                                        `</ul>` +
                                    `</div>`;
            if (localRanking.length === 0) {
                html += '<li id="local-empty-message">Nenhum score registrado ainda. Seja o primeiro!</li>';
            } else {
                localRanking.slice(0, 5).forEach((entry) => {
                    const status = entry.redeemed ? ' (‚úÖ Resgatado)' : '';
                    html += `
                        <li><strong>${entry.name}</strong>: ${entry.score} pts ${status}</li>
                    `;
                });
            }
            html += '</ol>';

            // √Årea reservada para ranking remoto (aqui mostramos o t√≠tulo principal e os dados remotos)
            rankingListDiv.innerHTML = html + `
                <div id="remote-ranking" style="margin-top:12px;">
                    <h3 style="margin:0 0 8px 0;">üèÜ Top 5 Triagens R√°pidas</h3>
                    <ul id="ranking"></ul>
                </div>
            `;

            // Se tivermos cache remoto, renderize imediatamente para reduzir percep√ß√£o de lat√™ncia
            try {
                if (remoteCached && remoteCached.length > 0) {
                    const remoteListEl = document.getElementById('ranking');
                    if (remoteListEl) {
                        // Mostrar apenas os top 5 do ranking remoto para manter consist√™ncia com o Top local
                        remoteListEl.innerHTML = (remoteCached || []).slice(0, 5).map((p, i) => `<li>${i + 1}. ${p.name} ‚Äî ${p.score} pts${p.count ? ` (${p.count} jogadas)` : ''}</li>`).join('');
                        const localEmpty = document.getElementById('local-empty-message');
                        if (localEmpty) localEmpty.style.display = 'none';
                    }
                }
            } catch (e) { console.warn('failed to render cached remote ranking', e); }

            // Anexa listener remoto se o m√≥dulo j√° estiver carregado; caso contr√°rio, poll e anexa quando dispon√≠vel
            try {
                if (!window._rankingListenerAttached && window.listenRanking && typeof window.listenRanking === 'function') {
                    window._rankingListenerAttached = true;
                    window.listenRanking((players) => {
                        const liveList = document.getElementById("ranking");
                        if (!liveList) return;
                        // Mostrar apenas top 5 do ranking remoto
                        liveList.innerHTML = (players || []).slice(0, 5).map((p, i) => `<li>${i + 1}. ${p.name} ‚Äî ${p.score} pts${p.count ? ` (${p.count} jogadas)` : ''}</li>`).join("");
                        const localEmpty = document.getElementById('local-empty-message');
                        if (localEmpty) {
                            if (players && players.length > 0) localEmpty.style.display = 'none';
                            else localEmpty.style.display = '';
                        }
                    });
                } else if (!window._rankingListenerAttached) {
                    // Poll curto para anexar listener quando o m√≥dulo estiver pronto
                    if (!window._rankingAttachPoll) {
                        let attempts = 0;
                        window._rankingAttachPoll = setInterval(() => {
                            attempts++;
                            if (window.listenRanking && typeof window.listenRanking === 'function') {
                                clearInterval(window._rankingAttachPoll);
                                window._rankingAttachPoll = null;
                                try {
                                    window._rankingListenerAttached = true;
                    window.listenRanking((players) => {
                        const liveList = document.getElementById("ranking");
                        if (!liveList) return;
                                        // Mostrar apenas top 5 do ranking remoto (anexado ap√≥s poll)
                                        liveList.innerHTML = (players || []).slice(0, 5).map((p, i) => `<li>${i + 1}. ${p.name} ‚Äî ${p.score} pts${p.count ? ` (${p.count} jogadas)` : ''}</li>`).join("");
                                        const localEmpty = document.getElementById('local-empty-message');
                                        if (localEmpty) {
                                            if (players && players.length > 0) localEmpty.style.display = 'none';
                                            else localEmpty.style.display = '';
                                        }
                                    });
                                } catch (e) { console.warn('failed to attach remote ranking listener after poll:', e); }
                            } else if (attempts > 20) { // para ap√≥s ~4 segundos
                                clearInterval(window._rankingAttachPoll);
                                window._rankingAttachPoll = null;
                            }
                        }, 200);
                    }
                }
            } catch (e) { console.warn('failed to attach remote ranking listener:', e); }
            
            checkAndSetStartButton();

            rankingOverlay.style.display = 'flex';
            document.querySelector('.game-container').style.display = 'none';
            // oculta CTA in-game quando o overlay estiver vis√≠vel
            inGameCta.style.display = 'none';
        }
        
        // Atualiza texto/estado do bot√£o de iniciar no overlay dependendo do nome e limite
        function checkAndSetStartButton() {
            const rawName = playerNameInput.value.trim();
            const nameForCheck = normalizeNameKey(rawName);

            // Verifica VIP de forma case-insensitive
            const isVIP = VIP_USERS.map(n => n.toLowerCase()).includes(nameForCheck);
            const count = loadPlayCount(rawName); // loadPlayCount j√° normaliza internamente
            const remaining = MAX_PLAYS - count;

            if (!isVIP && remaining <= 0) {
                 overlayStartButton.textContent = `LIMITE ATINGIDO (${MAX_PLAYS} JOGADAS)`;
                 overlayStartButton.disabled = true;
            } else {
                 let statusText = isVIP ? `COME√áAR PLANT√ÉO (ILIMITADO)` : `COME√áAR PLANT√ÉO (${remaining} de ${MAX_PLAYS})`;
                 overlayStartButton.textContent = statusText;
                 overlayStartButton.disabled = false;
            }
        }
        
        // Exporta dados brutos do ranking local para CSV (uso administrativo)
        function exportRankingToCSV() {
            const ranking = JSON.parse(localStorage.getItem(RANKING_KEY)) || [];
            
            if (ranking.length === 0) {
                alert('N√£o h√° dados para exportar.');
                return;
            }

            const headers = ['ID', 'Data/Hora', 'Nome', 'Score', 'Pr√™mio', 'Alertas Coletados', 'Erros/Distra√ß√µes', 'Resgatado'];
            let csv = headers.join(';') + '\n'; 

            ranking.forEach(entry => {
                const row = [
                    entry.id,
                    entry.timestamp,
                    `"${entry.name}"`, 
                    entry.score,
                    `"${entry.prize}"`,
                    entry.criticalHits,
                    entry.distractionFails,
                    entry.redeemed ? 'Sim' : 'N√£o'
                ].join(';');
                csv += row + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `Ranking_VitalCare_RAW_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            alert(`Sucesso! ${ranking.length} registros (raw) foram exportados para o arquivo CSV.`);
        }
        
        // --- FUN√á√ïES DE JOGO (L√ìGICA) ---
        // Determina fatores de dificuldade baseado no tempo restante
        function getDifficultyFactors() {
            const elapsed = GAME_DURATION - timeLeft;
            let tier = 0;
            if (elapsed >= 15) tier = 3; 
            else if (elapsed >= 10) tier = 2; 
            else if (elapsed >= 5) tier = 1; 
            
            const rateFactor = [1.0, 0.8, 0.6, 0.4]; 
            const lifespanFactor = [1.0, 0.8, 0.6, 0.4]; 

            return {
                newRate: BASE_GEN_RATE * rateFactor[tier],
                newLifespan: BASE_LIFESPAN * lifespanFactor[tier]
            };
        }
        
        function adjustGeneratorSpeed() {
            const factors = getDifficultyFactors();
            
            clearInterval(generatorInterval); 
            
            const newRate = factors.newRate;
            
            generatorInterval = setInterval(createTarget, newRate);
        }

        function createTarget() {
            if (!isRunning) return;

            const itemConfig = getRandomItemType();
            const target = document.createElement('div');
            
            const factors = getDifficultyFactors();
            const lifespan = factors.newLifespan; 
            
            target.className = `game-target ${itemConfig.type}`;
            target.textContent = itemConfig.type === 'distraction' ? 'üõë' : itemConfig.icon;
            
            const maxX = gameArea.clientWidth - 70;
            const maxY = gameArea.clientHeight - 70;
            target.style.left = `${Math.random() * maxX}px`;
            target.style.top = `${Math.random() * maxY}px`;
            
            target.onclick = () => {
                if (!isRunning) return;
                
                // NOVO: L√≥gica de Distra√ß√£o (Puni√ß√£o de Pontos)
                if (itemConfig.type === 'distraction') {
                    distractionFails++;
                    updateScore(itemConfig.points, itemConfig.type); // Aplica -8 pontos
                    playNegativeSound();
                    showHitFeedback(itemConfig.points, 'üõë');
                    target.remove();
                    return; 
                }

                // L√≥gica de Pontua√ß√£o normal
                updateScore(itemConfig.points, itemConfig.type);
                // play positive sound for rewards
                playPositiveSound();
                showHitFeedback(itemConfig.points, itemConfig.icon);
                target.remove();
            };

            gameArea.appendChild(target);

            target.style.animation = `pulseFade ${lifespan / 1000}s ease-in-out forwards`;

            setTimeout(() => {
                target.remove();
            }, lifespan);
        }
        
        function updateScore(points, type) {
            score += points;
            scoreDisplay.textContent = score;

            if (type === 'critical') criticalHits++;
            if (type === 'coffee') coffeeHits++;
        }

        function getRandomItemType() {
            const totalWeight = ITEM_CONFIG.reduce((sum, item) => sum + item.weight, 0);
            let randomNum = Math.floor(Math.random() * totalWeight);
            
            for (const item of ITEM_CONFIG) {
                if (randomNum < item.weight) {
                    return item;
                }
                randomNum -= item.weight;
            }
        }
        
        function startGame() {
            if (isRunning) return;
            
            currentPlayerName = playerNameInput.value.trim();

            if (!VIP_USERS.includes(currentPlayerName) && loadPlayCount(currentPlayerName) >= MAX_PLAYS) {
                 alert(`Desculpe, ${currentPlayerName}! Voc√™ j√° atingiu o limite de ${MAX_PLAYS} jogadas.`);
                 displayRanking();
                 return;
            }

            // Reseta estat√≠sticas
            score = 0;
            criticalHits = 0;
            coffeeHits = 0;
            distractionFails = 0;
            
            rankingOverlay.style.display = 'none';
            document.querySelector('.game-container').style.display = 'block';
            // hide in-game CTA while playing
            inGameCta.style.display = 'none';

            // Inicia o Countdown de 5 segundos
            let countdown = 5;
            resultMessage.textContent = `PREPARAR, ${currentPlayerName.toUpperCase()}! COME√áA EM ${countdown}...`;
            startButton.style.display = 'none';
            
            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    resultMessage.textContent = `PREPARAR! COME√áA EM ${countdown}...`;
                } else {
                    clearInterval(countdownInterval);
                    gameStartCore(); 
                }
            }, 1000);
        }
        
        function gameStartCore() {
            timeLeft = GAME_DURATION;
            isRunning = true;
            scoreDisplay.textContent = score;
            timerDisplay.textContent = timeLeft + 's';
            finalResultsContainer.style.display = 'none';

            const statusMessage = VIP_USERS.includes(currentPlayerName) ? 
                          `PLANT√ÉO ILIMITADO, ${currentPlayerName.toUpperCase()}!` :
                          `FOCO M√ÅXIMO, ${currentPlayerName.toUpperCase()}! CUIDADO COM O VERMELHO.`; // Mensagem ajustada
            resultMessage.textContent = statusMessage;
            
            clearInterval(generatorInterval);
            
            timerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = timeLeft + 's';
                
                adjustGeneratorSpeed(); 

                if (timeLeft <= 0) {
                    // Jogo SEMPRE termina por tempo
                    endGame(true, '‚úÖ FIM DO PLANT√ÉO! Seu tempo acabou.');
                }
            }, 1000);
            
            adjustGeneratorSpeed();
        }


        function classifyPrize(finalScore) {
            if (finalScore >= 120) return 'Exclusivo (Cord√£o)';
            // Acr√≠lico agora entre 100 e 119
            if (finalScore >= 100) return 'M√©dio (Chaveiro Acr√≠lico Azul)';
            // Simples agora entre 60 e 99
            if (finalScore >= 60) return 'Simples (Chaveiro MDF)';
            return 'Super Simples (Adesivo e Bala)'; 
        }

        function endGame(success, message) {
            // L√≥gica de EndGame (Sempre sucesso = true agora, pois Distraction n√£o encerra)
            isRunning = false;
            clearInterval(generatorInterval);
            clearInterval(timerInterval);
            
            document.querySelectorAll('.game-target').forEach(t => t.remove());

            let finalScore = score;
            let prize = classifyPrize(finalScore);
            
            // Salva o score e incrementa o contador de jogadas
            saveScore(currentPlayerName, finalScore, prize, criticalHits, distractionFails);
            const newPlayCount = incrementPlayCount(currentPlayerName); 

            // 1. Monta a Mensagem
            let playLimitStatus = `(Jogada ${newPlayCount} de ${MAX_PLAYS})`;
            if (VIP_USERS.includes(currentPlayerName)) {
                playLimitStatus = '(JOGADOR VIP - ILIMITADO)';
            } else if (newPlayCount >= MAX_PLAYS) {
                playLimitStatus = ' (LIMITE M√ÅXIMO ATINGIDO!)';
            }
            
            // A mensagem de EndGame n√£o precisa mais verificar 'success' baseado na distra√ß√£o
            message = `‚úÖ FIM DO PLANT√ÉO! Seu score final √© ${finalScore}. ${playLimitStatus}`;


            // 2. Montagem da Tela Final Detalhada
            finalResultsContainer.innerHTML = `
                <p style="font-size: 1.5em; color: #7FFFD4; font-weight: 700;">RESULTADOS DA TRIAGEM:</p>
                <p><strong>Status:</strong> <span style="color: #1EC3A5;">PLANT√ÉO CONCLU√çDO</span></p>
                <p><strong>Score Final:</strong> <span style="color: #ffc107;">${finalScore}</span></p>
                <hr style="border-color: rgba(255, 255, 255, 0.1); margin: 10px 0;">
                <p><strong>üö® Alertas Cr√≠ticos (x10):</strong> ${criticalHits}</p>
                <p><strong>‚òï Caf√©s de Sobrevida (x3):</strong> ${coffeeHits}</p>
                <p><strong>üõë Puni√ß√µes/Erros (-8 pts):</strong> ${distractionFails}</p>
                <hr style="border-color: rgba(255, 255, 255, 0.1); margin: 10px 0;">
                <p style="font-size: 1.4em; color: #993BC7;">PR√äMIO GANHO: ${prize}</p>
                <button id="checkout-button" class="start-button-style" data-id="${gameID}" 
                        style="background-color: #1EC3A5; margin-top: 15px;">RESGATAR PR√äMIO</button>
            `;
            finalResultsContainer.style.display = 'block';
            resultMessage.textContent = message;
            
            document.getElementById('checkout-button').onclick = handleCheckout;
            // show the in-game CTA centered over the game area
            inGameCta.style.display = 'flex';
                        // ensure running total reflects final score
                        runningTotal = score;
                        if (runningTotalEl) runningTotalEl.textContent = `${runningTotal} pts`;
        }
        
        function handleCheckout() {
            const token = document.getElementById('checkout-button').dataset.id;
            const password = prompt('Digite a senha da equipe (vitalcare2025) para confirmar o resgate do pr√™mio:'); 
            
            if (password === 'vitalcare2025') { 
                let ranking = JSON.parse(localStorage.getItem(RANKING_KEY)) || []; 
                const entryIndex = ranking.findIndex(e => String(e.id) === token);
                
                if (entryIndex !== -1 && !ranking[entryIndex].redeemed) {
                    ranking[entryIndex].redeemed = true;
                    localStorage.setItem(RANKING_KEY, JSON.stringify(ranking));
                    alert(`Pr√™mio de ${ranking[entryIndex].prize} resgatado com sucesso para ${ranking[entryIndex].name}!`);
                    displayRanking(); 
                } else {
                    alert('Pr√™mio j√° resgatado ou Token inv√°lido.');
                }
            } else {
                alert('Senha incorreta.');
            }
        }

        function setupBackgroundSymbols() {
            const symbols = ['üéÆ', 'ü©∫', '‚ö°', 'üíä', 'üíô', '‚öôÔ∏è', 'üéØ'];
            for (let i = 0; i < 20; i++) {
                const symbol = document.createElement('div');
                symbol.className = 'symbol';
                symbol.textContent = symbols[Math.floor(Math.random() * symbols.length)];
                symbol.style.left = `${Math.random() * 100}vw`;
                symbol.style.top = `${Math.random() * 100}vh`;
                symbol.style.animationDelay = `${Math.random() * -20}s`;
                backgroundSymbols.appendChild(symbol);
            }
        }


        // --- INICIALIZA√á√ÉO E EVENT HANDLERS ---
        
        nameForm.onsubmit = (e) => {
            e.preventDefault();
            
            const name = playerNameInput.value.trim();
            const lockedName = localStorage.getItem(LAST_USED_NAME_KEY);
            
            if (name.length < 3) {
                 alert("Por favor, insira um nome v√°lido com pelo menos 3 caracteres.");
                 return;
            }

          // Allow multiple different names on the same device. Enforce per-name play limit (case-insensitive)
          const normalized = normalizeNameKey(name);
          const isVIP = VIP_USERS.map(n => n.toLowerCase()).includes(normalized);
          if (!isVIP && loadPlayCount(name) >= MAX_PLAYS) {
              alert(`Desculpe, ${name}! Voc√™ j√° atingiu o limite de ${MAX_PLAYS} jogadas.`);
              displayRanking();
              return;
          }
            
            currentPlayerName = name;
            
            rankingOverlay.style.display = 'none';
            document.querySelector('.game-container').style.display = 'block';
            startGame(); 
        };
        
        playerNameInput.addEventListener('input', checkAndSetStartButton);
        exportButton.onclick = exportRankingToCSV;
        
        document.addEventListener('DOMContentLoaded', () => {
            setupBackgroundSymbols();
            checkAndSetStartButton(); 
            displayRanking();
        });
    </script>
    <script type="module">
  import { addPlayer, listenRanking } from "./ranking.js";

  const rankingList = document.getElementById("ranking");

  // Atualiza o ranking em tempo real
        listenRanking((players) => {
        const liveList = document.getElementById("ranking");
        if (!liveList) {
            console.warn('No #ranking element found when updating live ranking');
            return;
        }
            // Mostrar apenas top 5 no render em m√≥dulo tamb√©m
            liveList.innerHTML = (players || []).slice(0, 5)
                .map((p, i) => `<li>${i + 1}. ${p.name} ‚Äî ${p.score} pts${p.count ? ` (${p.count} jogadas)` : ''}</li>`)
                .join("");
        // If there are remote/global players, hide the local-empty message
        const localEmpty = document.getElementById('local-empty-message');
        if (localEmpty) {
            if (players && players.length > 0) localEmpty.style.display = 'none';
            else localEmpty.style.display = '';
        }
  });

  // Exemplo de adi√ß√£o manual (voc√™ pode adaptar)
  // addPlayer("Guilherme", 120);
</script>
</body>
</html>